{% include  'base.html' %}
{% load static %}
{% block contentarea%}
<title>Letworkbedone - Get Requirements</title>
<link rel="stylesheet" href="{% static 'assets/css/frontend/gig_requirements.css' %}" type="text/css" />
<div class="all_page page-flex__content pt0 m0">
    <input type="hidden" id="order_no" value="">
    <input type="hidden" id="order_by" value="">
    <input type="hidden" id="order_to" value="">
    <input type="hidden" id="gig_id" value="{{gig_id}}">
    <input type="hidden" id="already_sub" value="{{submitted}}">
    <div id="event_list" class="event-list js-event-list"></div>
    <div id="fox_notification_block"></div>
    <div class="row justify-content-center mt-0" id="user_gig_collect_req">
        <div class="col-lg-7 right_pan pt-4">
            <div class="general-note">
             <span class="fit-icon icn-info" style="width: 16px; height: 16px; fill: rgb(252, 131, 43);"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 0.25C3.72009 0.25 0.25 3.72134 0.25 8C0.25 12.2812 3.72009 15.75 8 15.75C12.2799 15.75 15.75 12.2812 15.75 8C15.75 3.72134 12.2799 0.25 8 0.25ZM8 3.6875C8.72487 3.6875 9.3125 4.27513 9.3125 5C9.3125 5.72487 8.72487 6.3125 8 6.3125C7.27513 6.3125 6.6875 5.72487 6.6875 5C6.6875 4.27513 7.27513 3.6875 8 3.6875ZM9.75 11.625C9.75 11.8321 9.58209 12 9.375 12H6.625C6.41791 12 6.25 11.8321 6.25 11.625V10.875C6.25 10.6679 6.41791 10.5 6.625 10.5H7V8.5H6.625C6.41791 8.5 6.25 8.33209 6.25 8.125V7.375C6.25 7.16791 6.41791 7 6.625 7H8.625C8.83209 7 9 7.16791 9 7.375V10.5H9.375C9.58209 10.5 9.75 10.6679 9.75 10.875V11.625Z"></path></svg>
             </span><b class="please-note">Please note:</b>
             Once requirements submitted never be modified. However you can submit your new or modified requirements within the order activity page.
          </div>
        </div>
        {% for gig_req in gig_requirements %}
        {% if forloop.last %}
        <div class="col-md-8 mx-0 section_text" id="section_text{{gig_req.id}}" >
            <div class="_2g7EPin custom-order-package-tooltip">
                <span class="_1iCafnp custom-order-package-tooltip-content">
                   <section class="request-description">
                      <p class="title">{{gig_req.gig_req_question |title}}:</p>
                      <div class="_27meMuG _3Dil0zw description text-body-2"><textarea maxlength="{{req_ans_char}}" data-label='{{gig_req.id}}' onkeyup="textarea_post_reqonkeyup(this);" onpaste="textarea_post_reqonkeyup(this);"  required placeholder="I'm looking for..."></textarea><span class="_5uzPJRN textarea_post_span">0/{{req_ans_char}}</span></div>
                      <div class="description-footer">
                         <div class="_2g7EPin fJuccPM file-uploader-tooltip">
                            <span class="_1iCafnp file-uploader-tooltip-content" >
                               <input type="file" hidden="" multiple="" id="upload_post_req{{gig_req.id}}" required onchange="upload_req_reqimgChange(this)" accept=
                               "application/msword, application/vnd.ms-excel, application/vnd.ms-powerpoint,
                               text/plain, application/pdf, image/*" >
                               <label class="FKiIhUG _1cZWUFp co-grey-1100 upload-button bg-co-grey-300" for="upload_post_req{{gig_req.id}}">
                                  <p class="upload-button-title">Attach Files</p>
                                  <span class="_1AB8XqH upload-button-icon" aria-hidden="true" style="width: 14px; height: 14px;">
                                     <svg width="13" height="14" viewBox="0 0 13 14" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M1.23276 12.7969C0.691092 12.2865 0.326868 11.6803 0.140086 10.9785C-0.0466954 10.2767 -0.0466954 9.57943 0.140086 8.88672C0.326868 8.19401 0.691092 7.59245 1.23276 7.08203L7.53664 0.902344C7.92888 0.519531 8.4005 0.255208 8.95151 0.109375C9.50251 -0.0364583 10.0535 -0.0364583 10.6045 0.109375C11.1555 0.255208 11.6365 0.524089 12.0474 0.916016C12.4583 1.30794 12.7385 1.77279 12.8879 2.31055C13.0374 2.84831 13.0374 3.38607 12.8879 3.92383C12.7385 4.46159 12.4583 4.93099 12.0474 5.33203L6.75216 10.5273C6.30388 10.9466 5.77155 11.1562 5.15517 11.1562C4.53879 11.1562 4.00647 10.9421 3.55819 10.5137C3.10991 10.0853 2.88578 9.57031 2.88578 8.96875C2.88578 8.36719 3.10991 7.84766 3.55819 7.41016L8.06897 3.00781C8.125 2.95312 8.19971 2.92578 8.2931 2.92578C8.38649 2.92578 8.46121 2.95312 8.51724 3.00781L8.99354 3.47266C9.06825 3.54557 9.1056 3.6276 9.1056 3.71875C9.1056 3.8099 9.06825 3.88281 8.99354 3.9375L4.51078 8.33984C4.32399 8.50391 4.2306 8.70898 4.2306 8.95508C4.2306 9.20117 4.32399 9.41081 4.51078 9.58398C4.69756 9.75716 4.91703 9.84375 5.16918 9.84375C5.42134 9.84375 5.63147 9.76172 5.79957 9.59766L11.1228 4.40234C11.4777 4.05599 11.6552 3.63216 11.6552 3.13086C11.6552 2.62956 11.4731 2.20117 11.1088 1.8457C10.7446 1.49023 10.3057 1.3125 9.79203 1.3125C9.27838 1.3125 8.83477 1.48568 8.46121 1.83203L2.15733 7.98438C1.61566 8.53125 1.34483 9.18294 1.34483 9.93945C1.34483 10.696 1.62033 11.3431 2.17134 11.8809C2.72234 12.4186 3.38542 12.6875 4.16056 12.6875C4.9357 12.6875 5.60345 12.4141 6.16379 11.8672L11.6272 6.50781C11.7019 6.45312 11.7859 6.42578 11.8793 6.42578C11.9727 6.42578 12.0474 6.45312 12.1034 6.50781L12.5797 6.97266C12.6545 7.04557 12.6918 7.1276 12.6918 7.21875C12.6918 7.3099 12.6545 7.38281 12.5797 7.4375L7.11638 12.7969C6.57471 13.3255 5.94899 13.681 5.23922 13.8633C4.52945 14.0456 3.81501 14.0456 3.09591 13.8633C2.3768 13.681 1.75575 13.3255 1.23276 12.7969Z"></path>
                                     </svg>
                                  </span>
                                 </label>
                            </span>
                         </div>
                      </div>
                   </section>
                </span>
             </div>
             <div class="_2g7EPin custom-order-package-tooltip" id="image_list">
    
             </div> 
             <div class="_2g7EPin custom-order-package-tooltip">
                <span class="_1iCafnp custom-order-package-tooltip-content">
                   <section class="budget-wrapper" id="btnwrapper">
                    <button type="button" class="FW1syM7 wapdb+q xaFER3a p9qU5Ka co-grey-1000 btn-custom-order" data-label="last" data-id="section_text{{gig_req.id}}" onclick="markassubmittedClick(this);"> <i class="fa fa-check-circle-o" aria-hidden="true"></i> Mark As Completed</button>
                    <input type="submit" class="FW1syM7 L1yjt43 p9qU5Ka co-white btn-contact-me bg-co-green-700"  data-label="last" data-id="section_text{{gig_req.id}}" onclick="btn_save_quoteClick(this);" id="btn_save_quote" value="Submit Requirements">
                   </section>
                </span>
             </div> 
             <div class="_2g7EPin custom-order-package-tooltip error_div">
                <span class="_1iCafnp custom-order-package-tooltip-content errorMssg" >
                    Please describe your answer.
                </span>
            </div> 
        </div>
        {% else %}
        <div class="col-md-8 mx-0 section_text" id="section_text{{gig_req.id}}">
            <div class="_2g7EPin custom-order-package-tooltip">
                <span class="_1iCafnp custom-order-package-tooltip-content">
                   <section class="request-description">
                      <p class="title">{{gig_req.gig_req_question |title}}:</p>
                      <div class="_27meMuG _3Dil0zw description text-body-2"><textarea maxlength="{{req_ans_char}}" data-label='{{gig_req.id}}' onkeyup="textarea_post_reqonkeyup(this);" onpaste="textarea_post_reqonkeyup(this);" required placeholder="I'm looking for..."></textarea><span class="_5uzPJRN textarea_post_span">0/{{req_ans_char}}</span></div>
                      <div class="description-footer">
                         <div class="_2g7EPin fJuccPM file-uploader-tooltip">
                            <span class="_1iCafnp file-uploader-tooltip-content" >
                               <input type="file" hidden="" multiple="" id="upload_post_req{{gig_req.id}}" required onchange="upload_req_reqimgChange(this)" accept=
                               "application/msword, application/vnd.ms-excel, application/vnd.ms-powerpoint,
                               text/plain, application/pdf, image/*" >
                               <label class="FKiIhUG _1cZWUFp co-grey-1100 upload-button bg-co-grey-300" for="upload_post_req{{gig_req.id}}">
                                  <p class="upload-button-title">Attach Files</p>
                                  <span class="_1AB8XqH upload-button-icon" aria-hidden="true" style="width: 14px; height: 14px;">
                                     <svg width="13" height="14" viewBox="0 0 13 14" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M1.23276 12.7969C0.691092 12.2865 0.326868 11.6803 0.140086 10.9785C-0.0466954 10.2767 -0.0466954 9.57943 0.140086 8.88672C0.326868 8.19401 0.691092 7.59245 1.23276 7.08203L7.53664 0.902344C7.92888 0.519531 8.4005 0.255208 8.95151 0.109375C9.50251 -0.0364583 10.0535 -0.0364583 10.6045 0.109375C11.1555 0.255208 11.6365 0.524089 12.0474 0.916016C12.4583 1.30794 12.7385 1.77279 12.8879 2.31055C13.0374 2.84831 13.0374 3.38607 12.8879 3.92383C12.7385 4.46159 12.4583 4.93099 12.0474 5.33203L6.75216 10.5273C6.30388 10.9466 5.77155 11.1562 5.15517 11.1562C4.53879 11.1562 4.00647 10.9421 3.55819 10.5137C3.10991 10.0853 2.88578 9.57031 2.88578 8.96875C2.88578 8.36719 3.10991 7.84766 3.55819 7.41016L8.06897 3.00781C8.125 2.95312 8.19971 2.92578 8.2931 2.92578C8.38649 2.92578 8.46121 2.95312 8.51724 3.00781L8.99354 3.47266C9.06825 3.54557 9.1056 3.6276 9.1056 3.71875C9.1056 3.8099 9.06825 3.88281 8.99354 3.9375L4.51078 8.33984C4.32399 8.50391 4.2306 8.70898 4.2306 8.95508C4.2306 9.20117 4.32399 9.41081 4.51078 9.58398C4.69756 9.75716 4.91703 9.84375 5.16918 9.84375C5.42134 9.84375 5.63147 9.76172 5.79957 9.59766L11.1228 4.40234C11.4777 4.05599 11.6552 3.63216 11.6552 3.13086C11.6552 2.62956 11.4731 2.20117 11.1088 1.8457C10.7446 1.49023 10.3057 1.3125 9.79203 1.3125C9.27838 1.3125 8.83477 1.48568 8.46121 1.83203L2.15733 7.98438C1.61566 8.53125 1.34483 9.18294 1.34483 9.93945C1.34483 10.696 1.62033 11.3431 2.17134 11.8809C2.72234 12.4186 3.38542 12.6875 4.16056 12.6875C4.9357 12.6875 5.60345 12.4141 6.16379 11.8672L11.6272 6.50781C11.7019 6.45312 11.7859 6.42578 11.8793 6.42578C11.9727 6.42578 12.0474 6.45312 12.1034 6.50781L12.5797 6.97266C12.6545 7.04557 12.6918 7.1276 12.6918 7.21875C12.6918 7.3099 12.6545 7.38281 12.5797 7.4375L7.11638 12.7969C6.57471 13.3255 5.94899 13.681 5.23922 13.8633C4.52945 14.0456 3.81501 14.0456 3.09591 13.8633C2.3768 13.681 1.75575 13.3255 1.23276 12.7969Z"></path>
                                     </svg>
                                  </span>
                                 </label>
                            </span>
                         </div>
                      </div>
                   </section>
                </span>
             </div>
             <div class="_2g7EPin custom-order-package-tooltip" id="image_list">
    
            </div> 
            <div class="_2g7EPin custom-order-package-tooltip">
                <span class="_1iCafnp custom-order-package-tooltip-content">
                   <section class="budget-wrapper" id="btnwrapper">
                    <button type="button" class="FW1syM7 wapdb+q xaFER3a p9qU5Ka co-grey-1000 btn-custom-order" data-label="next" data-id="section_text{{gig_req.id}}" onclick="markassubmittedClick(this);" ><i class="fa fa-check-circle-o" aria-hidden="true"></i> Mark As Completed</button>
                    <input type="submit" class="FW1syM7 L1yjt43 p9qU5Ka co-white btn-contact-me bg-co-green-700" id="btn_save_quote" data-id="section_text{{gig_req.id}}" data-label="next" onclick="btn_save_quoteClick(this);" value="Submit Requirements">
                   </section>
                </span>
             </div> 
             <div class="_2g7EPin custom-order-package-tooltip error_div">
                <span class="_1iCafnp custom-order-package-tooltip-content errorMssg" >
                    Please describe your answer.
                </span>
            </div> 
        </div>
        {% endif %}
        {% endfor %}
    </div>

    <div class="row tab1" id="sucess_div">
        <div class="col-lg-9  pt-4 sucess_inner" >
           <div class="almost-there publish-section">
              <h1>Great Order Started Sucessfully...</h1>
              <p>You can now share additional information on this order activity page.</p>
              <a onclick="order_activity_click();" class="order_active">Order activity page</a>
           </div>
        </div>
     </div>
</div>
{% include  'Dashboard/base_buyer.html' %}
<script>
    var chkReadyState = setInterval(function() {
        if (document.readyState == "complete") {
            clearInterval(chkReadyState);
            location_href =  $(location).attr('href').split("/");
            offer_id= location_href[5]
            base_price= location_href[6]
            total_price= location_href[7]
            fees = location_href[8]
            extra_gigs = location_href[9]
            used_credits = location_href[10]
            pay_user = location_href[11]
            $.ajax({
                type:"GET",
                url: "/post_credit_transaction/",
                data: {'offer_id': offer_id,'base_price': base_price,'total_price': total_price,'fees': fees,'extra_gigs': extra_gigs,'used_credits': used_credits,'pay_user': pay_user,'pay_by':'{{request.user.username}}'},
                success: function(data)
                {
                    jsonObj = JSON.parse(data);
                    $("#order_no").val(jsonObj[0].order_no);
                    $("#order_by").val(jsonObj[0].ordered_by);
                    $("#order_to").val(jsonObj[0].ordered_to);
                    $("#already_sub").val(jsonObj[0].submitted);
                    $(".section_text:first").show();
                    if(parseInt($("#already_sub").val()) >0)
                    {
                        $("#user_gig_collect_req").hide();
                        $("#sucess_div").show();
                    }
                    else{
                        $("#user_gig_collect_req").show();
                        $("#sucess_div").hide();
                    }
                }
            });
        }
    }, 100);
    $(document).ready(function(){

    });

    function markassubmittedClick(ev)
    {
        data_next = $(ev).attr("data-label");
        data_sec_id = $(ev).attr("data-id");
        $.ajax({
            type:"GET",
            url: "/post_mark_as_read/",
            data: {'gig_id': $("#gig_id").val(),'user_id': $("#order_by").val(),'req_ques':$("#"+data_sec_id).find(".title").text(),"order_no":$("#order_no").val()},
            success: function(data)
            {
                if(data_next=="next")
                {
                    $("#"+data_sec_id).hide();
                    $("#"+data_sec_id).next().show();
                }
                else{
                    $("#user_gig_collect_req").hide();
                    $("#sucess_div").show();
                }
            }
        });  
    }
    function btn_save_quoteClick(ev)
    {
        data_next = $(ev).attr("data-label");
        data_sec_id = $(ev).attr("data-id");
        var imgList= '';
        $("#"+ data_sec_id).find("#image_list").find('.imagediv').each(function(ev){ 
            imgList = imgList +", "+  $(this).find('img').attr("src");
        });
        if($("#"+data_sec_id).find("textarea").val().trim().length != 0)
        {
            $("#"+ data_sec_id).find(".error_div").hide(); 
            $.ajax({
                type:"GET",
                url: "/post_buyer_requ_save/",
                data:  {'gig_id': $("#gig_id").val(),'user_id': $("#order_by").val(),'req_ques':$("#"+data_sec_id).find(".title").text(),'req_ans':$("#"+data_sec_id).find("textarea").val(),'req_imgs':imgList,"order_no":$("#order_no").val()},
                success: function(data)
                {
                    if(data_next=="next")
                    {
                        $("#"+data_sec_id).hide();
                        $("#"+data_sec_id).next().show();
                    }
                    else{
                        $("#user_gig_collect_req").hide();
                        $("#sucess_div").show();
                    }
                }
            });
        }
        else{
            $("#"+ data_sec_id).find(".error_div").show(); 
        }
          
    }

    function textarea_post_reqonkeyup(ev)
    {
        setTimeout(function() {
        var gig_req_id = $(ev).attr("data-label");
        var thisChars = $(ev).val().replace(/{.*}/g, '').length; 
        var maxlength = $(ev).attr("maxlength");
        if(thisChars > maxlength) 
        {
            var CharsToDel = (thisChars-maxlength); 
            $(ev).val(this.value.substring(0,$(ev).val().length-CharsToDel)); 
        }else{
            $("#section_text"+gig_req_id).find(".textarea_post_span").text( maxlength - thisChars + " /"+maxlength); 
        }
    }, 500);  
    }
    function order_activity_click()
    {
        order_no = $("#order_no").val();
        username = ''
        if("{{request.user.username}}" == $("#order_by").val())
        {
            username = $("#order_by").val();
        }
        else{
            username = $("#order_to").val();
        }
        location_href =  $(location).attr('href').split("/");
        window.location.href = location_href[0]+"//"+location_href[2] +"/user/"+username+"/manage_orders/"+order_no+"/activities";
    }
    function upload_req_reqimgChange(ev)
    {
        id= $(ev).attr("id");
        console.log(id);
        parent_id_num = id.match(/\d+/)[0];
        parent_id_div = "#section_text"+parent_id_num;
		var fd = new FormData();
        var files = $("#" + id).get(0).files;
		if(files.length > 0 ){
            for (var i = 0; i < files.length; i++) {
                fd.append("files", files[i]);
            }
			var xhr=new XMLHttpRequest();
			xhr.open("POST","/post_req_image_upload/",true);
			xhr.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var data=xhr.responseText;
                    data1 = JSON.parse(data);
                    $.each(data1, function (key, value) {
                        $.each(value, function (key1, value1){
                            $(parent_id_div).find("#image_list").append('<div class="img'+(key1+1)+' imagediv"><img src='+value1+' id="img'+(key1+1)+'"><i class="fa fa-trash" onclick="post_img_delete(this);"></i></img></div>');
                        });
                    });
				}};
			xhr.send(fd);
		}
		else{
			alert("Please select a file.");
		 }
    }

    function post_img_delete(ev)
    {
        $(ev).parent().remove();
    }
</script>
{% endblock %}