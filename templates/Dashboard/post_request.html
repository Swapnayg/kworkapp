{% include  'base.html' %}
{% load static %}
{% block contentarea%}
<title>Letworkbedone - Request a Custom Order</title>
<link rel="stylesheet" href="{% static 'assets/css/frontend/post_request.css' %}" type="text/css" />
<div class="all_page page-flex__content pt0 m0">
    <div id="event_list" class="event-list js-event-list"></div>
    <div id="fox_notification_block"></div>
    <div class="row justify-content-center mt-0" id="manage_gigs">
       <div class="col-11 text-center p-0 mt-3 mb-2">
          <div class="card px-0 pt-4 pb-0 mb-3"  id="manage_gigs_card">
             <div class="row">
                <div class="col-md-12 db-manage-gigs ">
                    <h1 class="alt">What Service Are You Looking For?</h1>
                </div>
                <div class="col-md-8 mx-0" id="order_desc">
                    <div class="custom-order-package">
                        <form id="quote_form">
                        <div class="_2g7EPin custom-order-package-tooltip">
                           <span class="_1iCafnp custom-order-package-tooltip-content">
                              <section class="request-description">
                                 <p class="title">Describe the service you're looking to purchase - please be as detailed as possible:</p>
                                 <div class="_27meMuG _3Dil0zw description text-body-2"><textarea maxlength="{{character_post_request}}" onkeyup="textarea_post_reqonkeyup(this);" onpaste="textarea_post_reqonkeyup(this);" id="textarea_post_req" required placeholder="I'm looking for..."></textarea><span class="_5uzPJRN" id="textarea_post_span">0/{{character_post_request}}</span></div>
                                 <div class="description-footer">
                                    <div class="_2g7EPin fJuccPM file-uploader-tooltip">
                                       <span class="_1iCafnp file-uploader-tooltip-content" >
                                          <input type="file" hidden="" multiple="" id="upload_post_req" onchange="upload_post_reqimgChange(this)" accept=
                                          "application/msword, application/vnd.ms-excel, application/vnd.ms-powerpoint,
                                          text/plain, application/pdf, image/*" >
                                          <label class="FKiIhUG _1cZWUFp co-grey-1100 upload-button bg-co-grey-300" for="upload_post_req">
                                             <p class="upload-button-title">Attach Files</p>
                                             <span class="_1AB8XqH upload-button-icon" aria-hidden="true" style="width: 14px; height: 14px;">
                                                <svg width="13" height="14" viewBox="0 0 13 14" xmlns="http://www.w3.org/2000/svg">
                                                   <path fill-rule="evenodd" clip-rule="evenodd" d="M1.23276 12.7969C0.691092 12.2865 0.326868 11.6803 0.140086 10.9785C-0.0466954 10.2767 -0.0466954 9.57943 0.140086 8.88672C0.326868 8.19401 0.691092 7.59245 1.23276 7.08203L7.53664 0.902344C7.92888 0.519531 8.4005 0.255208 8.95151 0.109375C9.50251 -0.0364583 10.0535 -0.0364583 10.6045 0.109375C11.1555 0.255208 11.6365 0.524089 12.0474 0.916016C12.4583 1.30794 12.7385 1.77279 12.8879 2.31055C13.0374 2.84831 13.0374 3.38607 12.8879 3.92383C12.7385 4.46159 12.4583 4.93099 12.0474 5.33203L6.75216 10.5273C6.30388 10.9466 5.77155 11.1562 5.15517 11.1562C4.53879 11.1562 4.00647 10.9421 3.55819 10.5137C3.10991 10.0853 2.88578 9.57031 2.88578 8.96875C2.88578 8.36719 3.10991 7.84766 3.55819 7.41016L8.06897 3.00781C8.125 2.95312 8.19971 2.92578 8.2931 2.92578C8.38649 2.92578 8.46121 2.95312 8.51724 3.00781L8.99354 3.47266C9.06825 3.54557 9.1056 3.6276 9.1056 3.71875C9.1056 3.8099 9.06825 3.88281 8.99354 3.9375L4.51078 8.33984C4.32399 8.50391 4.2306 8.70898 4.2306 8.95508C4.2306 9.20117 4.32399 9.41081 4.51078 9.58398C4.69756 9.75716 4.91703 9.84375 5.16918 9.84375C5.42134 9.84375 5.63147 9.76172 5.79957 9.59766L11.1228 4.40234C11.4777 4.05599 11.6552 3.63216 11.6552 3.13086C11.6552 2.62956 11.4731 2.20117 11.1088 1.8457C10.7446 1.49023 10.3057 1.3125 9.79203 1.3125C9.27838 1.3125 8.83477 1.48568 8.46121 1.83203L2.15733 7.98438C1.61566 8.53125 1.34483 9.18294 1.34483 9.93945C1.34483 10.696 1.62033 11.3431 2.17134 11.8809C2.72234 12.4186 3.38542 12.6875 4.16056 12.6875C4.9357 12.6875 5.60345 12.4141 6.16379 11.8672L11.6272 6.50781C11.7019 6.45312 11.7859 6.42578 11.8793 6.42578C11.9727 6.42578 12.0474 6.45312 12.1034 6.50781L12.5797 6.97266C12.6545 7.04557 12.6918 7.1276 12.6918 7.21875C12.6918 7.3099 12.6545 7.38281 12.5797 7.4375L7.11638 12.7969C6.57471 13.3255 5.94899 13.681 5.23922 13.8633C4.52945 14.0456 3.81501 14.0456 3.09591 13.8633C2.3768 13.681 1.75575 13.3255 1.23276 12.7969Z"></path>
                                                </svg>
                                             </span>
                                            </label>
                                       </span>
                                    </div>
                                 </div>
                              </section>
                           </span>
                        </div>
                        <div class="_2g7EPin custom-order-package-tooltip" id="image_list">
    
                        </div>    
                        <div class="_2g7EPin custom-order-package-tooltip">
                           <span class="_1iCafnp custom-order-package-tooltip-content">
                              <section class="choose-categories-wrapper">
                                 <h3>Choose a category:</h3>
                                 <div class="choose-categories">
                                    <div class="categories-wrapper">
                                       <div class="_2g7EPin _2SsU-73 _1dJ3UV8 categories-select">
                                          <select id="post_category" required>
                                             <option value="">Select Category</option>
                                             {% for cat in categories %}
                                                <option value="{{cat.id}}">{{cat.category_Name}}</option>
                                            {% endfor %}
                                          </select>
                                       </div>
                                    </div>
                                    <div class="categories-wrapper">
                                       <div class="_2g7EPin _2SsU-73 _1dJ3UV8 categories-select _2FV4hzr">
                                          <select id="post_sub_category" required>
                                             <option value="">Select Sub-Category</option>
                                             <option value="1"> Options 1</option>
                                          </select>
                                       </div>
                                    </div>
                                 </div>
                              </section>
                           </span>
                        </div>
                        <div class="_2g7EPin custom-order-package-tooltip">
                           <span class="_1iCafnp custom-order-package-tooltip-content">
                              <section class="delivery-time-wrapper">
                                 <h3>Once you place your order, when would you like your service delivered?</h3>
                                 <div class="delivery-time">
                                    <div class="FKiIhUG _1cZWUFp _2txg6PD H69bvrM co-grey-1100">
                                        <input type="radio" name="post_time" required class="post_time" value="24hours" id="24_post_time">
                                        <label for="24_post_time">24 Hours</label>
                                    </div>
                                    <div class="FKiIhUG _1cZWUFp _2txg6PD H69bvrM co-grey-1100">
                                        <input type="radio" name="post_time" required class="post_time" value="3days" id="3_post_time">
                                        <label for="3_post_time">3 Days</label>
                                    </div>
                                    <div class="FKiIhUG _1cZWUFp _2txg6PD H69bvrM co-grey-1100">
                                        <input type="radio" name="post_time" required class="post_time"  value="7days"  id="7_post_time">
                                        <label  for="7_post_time">7 Days</label>
                                    </div>
                                    <div class="FKiIhUG _1cZWUFp _2txg6PD H69bvrM co-grey-1100">
                                        <input type="radio" name="post_time" required class="post_time" value="other"  id="other_post_time">
                                        <label  for="other_post_time">Other</label>
                                    </div>
                                 <div class="error-message"></div>
                              </section>
                           </span>
                        </div>
                        <div class="_2g7EPin custom-order-package-tooltip">
                           <span class="_1iCafnp custom-order-package-tooltip-content">
                              <section class="budget-wrapper">
                                 <h3>What is your budget for this service?</h3>
                                 <div class="budget-input">
                                    <small class="currency-symbol">$</small>
                                    <div class="_2XlT5rY D6s0wIv">
                                       <div class="_3SnSqB3">
                                          <input class="_2DtRW7Q" type="number" data-min="{{minimum_selling_price}}" id="service_price"  value="" required>
                                       </div>
                                    </div>
                                 </div>
                              </section>
                              <span id="service_price_Messg" class="error">Price should be greater than {{minimum_selling_price}}.</span>
                           </span>
                        </div>
                        <div class="_2g7EPin custom-order-package-tooltip">
                            <span class="_1iCafnp custom-order-package-tooltip-content">
                               <section class="budget-wrapper" id="btnwrapper">
                                <button type="button" class="FW1syM7 wapdb+q xaFER3a p9qU5Ka co-grey-1000 btn-custom-order" data-dismiss="modal">Cancel</button>
                                <input type="submit" class="FW1syM7 L1yjt43 p9qU5Ka co-white btn-contact-me bg-co-green-700" id="btn_save_quote" value="Save changes">
                               </section>
                            </span>
                         </div> 
                         <div class="_2g7EPin custom-order-package-tooltip">
                            <span class="_1iCafnp custom-order-package-tooltip-content" id="successMssg">
                                Request Posted Sucessfully.
                            </span>
                        </div> 
                    </form>
                     </div>
                </div>     
             </div>
          </div>
       </div>
    </div>
 </div>
{% include  'Dashboard/base_buyer.html' %}
<style>
   #btn_save_quote:disabled{
      cursor: not-allowed;
      cursor: -moz-not-allowed;
      cursor: -webkit-not-allowed;
  }
</style>
<script>
    $(document).ready(function(){
      $("#service_price_Messg").hide();
      $("#service_price").keyup(function() {
         min_val = $("#service_price").attr("data-min");
         if(parseInt($('#service_price').val()) >= parseInt(min_val)){
            $("#service_price_Messg").hide();
            $("#service_price_Messg").text("valid");
         }
         else{
            $("#service_price_Messg").text("Price should be greater than {{minimum_selling_price}}.");
            $("#service_price_Messg").show();
         }
       });
        $("#successMssg").hide();
        $('#post_category').change(function() {
            this_txt = $("#post_category option:selected").text().trim();
            this_val = $("#post_category").val();
            if(this_txt != "Select Category")
            {
               $.ajax({
                  type:"GET",
                  url: "/get_sub_categories/",
                  data: {"sub_category":this_txt},
                  success: function(data) 
                  {
                     $("#post_sub_category").empty();
                     $("#post_sub_category").append('<option value="" selected=""> Select Sub-Category </option>')
                     $.each(data, function(i, v) {
                           $("#post_sub_category").append('<option value="'+v.sub_cat_id+'"> '+v.sub_cat_name+' </option>');
                     });
                  }
               });
            }
         }); 
        $("#quote_form").submit(function(e)
        {
            e.preventDefault();
            if($("#service_price_Messg").text() == "valid"){
               post_req_desc= $("#textarea_post_req").val();
               imgList= '';
               $("#quote_form").find("#image_list").find('.imagediv').each(function(ev){ 
                  imgList = imgList +", "+   $(this).find('.img_file_name').val();
               });
               post_category = $("#post_category").val();
               post_sub_category = $("#post_sub_category").val();
               service_time = $("input[type='radio'][name='post_time']:checked").val();
               service_price = $("#service_price").val();
               $("#btn_save_quote").prop("disabled",true);
               $.ajax({
                  type:"POST",
                  url: "/post_service_request/",
                  data: {'userid':'{{request.user.id}}','service_descp':post_req_desc,'service_images':imgList,'service_cat':post_category,'service_sub_cat':post_sub_category,'service_time':service_time,'service_price':service_price,"service_type":"all",'send_to': window.location.pathname.split("/")[3]},
                  success: function(data) 
                  {  
                     if(data == "sucess")
                     {
                           $("#btn_save_quote").prop("disabled",false);
                           $('#quote_form')[0].reset();
                           $("#quote_form").find("#image_list").empty();
                           $("#image_list").empty();
                           $("#successMssg").show();
                           location_href =  $(location).attr('href').split("/");
                           window.location.href = location_href[0]+"//"+location_href[2] + "/buyer";
                     }
                  }   
               });
            }
            else{
               $("#service_price_Messg").text("Price should be greater than {{minimum_selling_price}}.");
               $("#service_price_Messg").show();
            }
      });
    });
    function textarea_post_reqonkeyup(ev)
    {
      setTimeout(function() {
        var thisChars = $(ev).val().replace(/{.*}/g, '').length; 
        var maxlength = $(ev).attr("maxlength");
        if(thisChars > maxlength) 
        {
            var CharsToDel = (thisChars-maxlength); 
            $(ev).val(this.value.substring(0,$(ev).val().length-CharsToDel)); 
        }else{
            $("#textarea_post_span").text( maxlength - thisChars + " /"+maxlength); 
        }
      }, 500);
    }
    function upload_post_reqimgChange(ev)
    {
        id="upload_post_req";
		var fd = new FormData();
        var files = $("#upload_post_req").get(0).files;
		if(files.length > 0 ){
            for (var i = 0; i < files.length; i++) {
                fd.append("files", files[i]);
            }
			var xhr=new XMLHttpRequest();
			xhr.open("POST","/post_request_image_upload/",true);
			xhr.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var data=xhr.responseText;
                    data1 = JSON.parse(data);
                    $.each(data1, function (key, value) {
                        $.each(value, function (key1, value1){
                           $("#image_list").css("height", "100px");
                           $("#image_list").append('<div class="img'+(key1+1)+' imagediv" id="mssg_img'+(key1+1)+'"><input type="hidden" value="'+value1+'" class="img_file_name"> <span class= "fa fa-file-o fileicon"><i class="fa fa-trash" onclick="post_img_message_delete(this);" data-label="mssg_img'+(key1+1)+' "></i></span><span class="file_name">...'+value1.slice(-20)+'</span>');
                        });
                    });
				}};
			xhr.send(fd);
		}
		else{
			alert("Please select a file.");
		 }
    }

    function post_img_delete(ev)
    {
        $(ev).parent().remove();
    }
    function post_img_message_delete(ev)
    {
       div_id = $(ev).attr("data-label");
       $("#image_list").find("#" +div_id).remove();
    }

</script>
{% endblock %}